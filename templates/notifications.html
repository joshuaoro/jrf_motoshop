{% extends "base_new.html" %}

{% block title %}Notifications - JRF System{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Notifications</h1>
        <div class="flex space-x-3">
            {% if unread_notifications > 0 %}
            <button onclick="markAllNotificationsRead()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-check-double mr-2"></i>Mark All Read
            </button>
            {% endif %}
            <button onclick="clearAllNotifications()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                <i class="fas fa-trash mr-2"></i>Clear All
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex flex-wrap gap-4">
            <div class="flex items-center space-x-2">
                <label for="filter-type" class="text-sm font-medium text-gray-700">Filter:</label>
                <select id="filter-type" onchange="filterNotifications()" class="px-3 py-1 border rounded-md text-sm">
                    <option value="all">All Notifications</option>
                    <option value="unread">Unread Only</option>
                    <option value="info">Info</option>
                    <option value="success">Success</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="filter-category" class="text-sm font-medium text-gray-700">Category:</label>
                <select id="filter-category" onchange="filterNotifications()" class="px-3 py-1 border rounded-md text-sm">
                    <option value="all">All Categories</option>
                    <option value="system">System</option>
                    <option value="inventory">Inventory</option>
                    <option value="sales">Sales</option>
                    <option value="staff">Staff</option>
                    <option value="backup">Backup</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div id="notifications-container" class="bg-white rounded-lg shadow-md">
        <div id="notifications-list">
            <!-- Notifications will be loaded here -->
        </div>
        
        <!-- Loading indicator -->
        <div id="loading" class="p-8 text-center">
            <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
            <p class="text-gray-500 mt-2">Loading notifications...</p>
        </div>
        
        <!-- Empty state -->
        <div id="empty-state" class="p-8 text-center hidden">
            <i class="fas fa-bell text-gray-300 text-4xl mb-3"></i>
            <p class="text-gray-500">No notifications found</p>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="p-4 border-t border-gray-200 hidden">
            <div class="flex justify-between items-center">
                <span id="pagination-info" class="text-sm text-gray-600"></span>
                <div class="flex space-x-2">
                    <button id="prev-page" onclick="loadPage(currentPage - 1)" class="px-3 py-1 border rounded-md text-sm hover:bg-gray-50 disabled:opacity-50">
                        Previous
                    </button>
                    <button id="next-page" onclick="loadPage(currentPage + 1)" class="px-3 py-1 border rounded-md text-sm hover:bg-gray-50 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilter = 'all';
let currentCategory = 'all';

// Load notifications on page load
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
});

async function loadNotifications(page = 1) {
    currentPage = page;
    
    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('empty-state');
    const notificationsList = document.getElementById('notifications-list');
    const pagination = document.getElementById('pagination');
    
    loading.classList.remove('hidden');
    emptyState.classList.add('hidden');
    notificationsList.innerHTML = '';
    pagination.classList.add('hidden');
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 20,
            unread_only: currentFilter === 'unread' ? 'true' : 'false'
        });
        
        const response = await fetch(`/api/notifications?${params}`);
        const data = await response.json();
        
        loading.classList.add('hidden');
        
        if (data.notifications && data.notifications.length > 0) {
            renderNotifications(data.notifications);
            updatePagination(data);
        } else {
            emptyState.classList.remove('hidden');
        }
        
        // Update unread count in header
        updateUnreadCount(data.unread_count);
        
    } catch (error) {
        console.error('Error loading notifications:', error);
        loading.classList.add('hidden');
        notificationsList.innerHTML = '<div class="p-8 text-center text-red-500">Error loading notifications</div>';
    }
}

function renderNotifications(notifications) {
    const notificationsList = document.getElementById('notifications-list');
    
    notifications.forEach(notification => {
        const notificationEl = document.createElement('div');
        notificationEl.className = `p-4 border-b border-gray-100 hover:bg-gray-50 ${!notification.is_read ? 'bg-blue-50' : ''}`;
        notificationEl.setAttribute('data-notification-id', notification.id);
        
        const iconClass = getNotificationIcon(notification.type);
        const iconColor = getNotificationColor(notification.type);
        
        notificationEl.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0 mr-3">
                    <i class="${iconClass} ${iconColor}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 ${!notification.is_read ? 'font-semibold' : ''}">
                        ${notification.title}
                    </p>
                    <p class="text-sm text-gray-600 mt-1">
                        ${notification.message}
                    </p>
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-xs text-gray-400">
                            ${notification.time_ago}
                        </p>
                        <div class="flex space-x-2">
                            ${notification.action_url ? `
                                <a href="${notification.action_url}" 
                                   class="text-xs text-blue-600 hover:text-blue-800"
                                   onclick="markNotificationRead(${notification.id})">
                                    ${notification.action_text || 'View'}
                                </a>
                            ` : ''}
                            ${!notification.is_read ? `
                                <button onclick="markNotificationRead(${notification.id})" 
                                        class="text-xs text-gray-500 hover:text-gray-700">
                                    Mark as read
                                </button>
                            ` : ''}
                            <button onclick="deleteNotification(${notification.id})" 
                                    class="text-xs text-red-500 hover:text-red-700">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        notificationsList.appendChild(notificationEl);
    });
}

function getNotificationIcon(type) {
    const icons = {
        'success': 'fas fa-check-circle',
        'warning': 'fas fa-exclamation-triangle',
        'error': 'fas fa-times-circle',
        'info': 'fas fa-info-circle'
    };
    return icons[type] || 'fas fa-info-circle';
}

function getNotificationColor(type) {
    const colors = {
        'success': 'text-green-500',
        'warning': 'text-yellow-500',
        'error': 'text-red-500',
        'info': 'text-blue-500'
    };
    return colors[type] || 'text-blue-500';
}

function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');
    const prevPage = document.getElementById('prev-page');
    const nextPage = document.getElementById('next-page');
    
    if (data.pages > 1) {
        pagination.classList.remove('hidden');
        paginationInfo.textContent = `Page ${data.current_page} of ${data.pages} (${data.total} total)`;
        
        prevPage.disabled = data.current_page <= 1;
        nextPage.disabled = data.current_page >= data.pages;
    }
}

function loadPage(page) {
    loadNotifications(page);
}

function filterNotifications() {
    currentFilter = document.getElementById('filter-type').value;
    currentCategory = document.getElementById('filter-category').value;
    loadNotifications(1);
}

async function deleteNotification(notificationId) {
    if (!confirm('Are you sure you want to delete this notification?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/notifications/${notificationId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Remove from UI
            const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationEl) {
                notificationEl.remove();
            }
            
            // Update unread count
            updateUnreadCount(data.unread_count);
            
            // Reload if no more notifications
            if (document.querySelectorAll('[data-notification-id]').length === 0) {
                loadNotifications();
            }
        }
    } catch (error) {
        console.error('Error deleting notification:', error);
    }
}

async function clearAllNotifications() {
    if (!confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/notifications/clear-all', {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadNotifications();
        }
    } catch (error) {
        console.error('Error clearing notifications:', error);
    }
}
</script>
{% endblock %}
