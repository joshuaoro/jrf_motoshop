{% extends "base_new.html" %}

{% block page_type %}reports{% endblock %}

{% block title %}Reports - JRF System Panel{% endblock %}

{% block page_title %}Reports & Analytics{% endblock %}

{% block extra_css %}
<style>
    .report-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Reports & Analytics</h1>
        <div class="flex space-x-3">
            <select id="dateRange" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="365">Last Year</option>
            </select>
            <button type="button" onclick="exportReports()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors cursor-pointer">
                <i class="fas fa-download mr-2"></i>Export
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="report-card bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Total Revenue</p>
                    <p id="totalRevenue" class="text-2xl font-bold text-gray-800">{{ currency_symbol }}0</p>
                    <p class="text-sm text-green-600 mt-1">
                        <i class="fas fa-arrow-up"></i> All time sales
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="report-card bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Total Sales</p>
                    <p id="totalSales" class="text-2xl font-bold text-gray-800">0</p>
                    <p class="text-sm text-green-600 mt-1">
                        <i class="fas fa-arrow-up"></i> All transactions
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="report-card bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Low Stock Items</p>
                    <p id="lowStockItems" class="text-2xl font-bold text-gray-800">0</p>
                    <p class="text-sm text-yellow-600 mt-1">
                        <i class="fas fa-exclamation-triangle"></i> Needs attention
                    </p>
                </div>
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-box text-yellow-600"></i>
                </div>
            </div>
        </div>

        <div class="report-card bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Today's Sales</p>
                    <p id="todaysRevenue" class="text-2xl font-bold text-gray-800">{{ currency_symbol }}0</p>
                    <p class="text-sm text-blue-600 mt-1">
                        <i class="fas fa-calendar-day"></i> <span id="todaysSalesCount">0</span> transactions
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-cash-register text-blue-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Sales Chart -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Sales Trend</h3>
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Revenue by Category -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Revenue by Category</h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Today's Sales Details -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Today's Sales Details</h3>
            <div class="text-sm text-gray-500">
                <span id="todayDate"></span>
            </div>
        </div>
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
            <table class="w-full text-sm">
                <thead class="sticky top-0 bg-gray-50">
                    <tr class="border-b">
                        <th class="text-left py-3 px-2">Time</th>
                        <th class="text-left py-3 px-2">Customer</th>
                        <th class="text-right py-3 px-2">Amount</th>
                        <th class="text-left py-3 px-2">Payment</th>
                        <th class="text-left py-3 px-2">Staff</th>
                    </tr>
                </thead>
                <tbody id="todaysSalesTableBody">
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading today's sales...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detailed Reports -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Top Products -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Top Products</h3>
                <div class="text-sm text-gray-500">
                    <span id="topProductsCount">0</span> products total
                </div>
            </div>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full text-sm sticky top-0 bg-white">
                    <thead class="sticky top-0 bg-gray-50">
                        <tr class="border-b">
                            <th class="text-left py-3 px-2">Product Name</th>
                            <th class="text-right py-3 px-2">Units Sold</th>
                            <th class="text-right py-3 px-2">Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsTableBody">
                        <tr>
                            <td colspan="3" class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading products data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Low Stock Items</h3>
                <div class="text-sm text-gray-500">
                    <span id="lowStockCount">0</span> items need restocking
                </div>
            </div>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-gray-50">
                        <tr class="border-b">
                            <th class="text-left py-3 px-2">Product Name</th>
                            <th class="text-center py-3 px-2">Stock</th>
                            <th class="text-right py-3 px-2">Price</th>
                        </tr>
                    </thead>
                    <tbody id="lowStockTableBody">
                        <tr>
                            <td colspan="3" class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading low stock data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Helper function to get payment method badge
    function getPaymentBadge(method) {
        const badges = {
            'cash': '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Cash</span>',
            'card': '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Card</span>',
            'gcash': '<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">GCash</span>',
            'paymaya': '<span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">PayMaya</span>'
        };
        return badges[method] || '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Other</span>';
    }

    // Load real sales data from API
    fetch('/api/sales-data')
        .then(response => response.json())
        .then(data => {
            // Get currency symbol from template
            const currencySymbol = '{{ currency_symbol }}';
            
            // Update summary cards with real data
            document.getElementById('totalRevenue').textContent = currencySymbol + data.statistics.total_revenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalSales').textContent = data.statistics.total_sales.toLocaleString();
            document.getElementById('lowStockItems').textContent = data.statistics.low_stock_parts.toLocaleString();
            
            // Load today's sales data
            loadTodaysSales();
            
            // Update top products table with all records
            const topProductsTableBody = document.getElementById('topProductsTableBody');
            document.getElementById('topProductsCount').textContent = data.top_parts.length;
            
            if (data.top_parts.length === 0) {
                topProductsTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-8 text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>No sales data available
                        </td>
                    </tr>
                `;
            } else {
                topProductsTableBody.innerHTML = data.top_parts.map(part => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-2 font-medium">${part.name}</td>
                        <td class="py-3 px-2 text-right">${part.units_sold}</td>
                        <td class="py-3 px-2 text-right font-semibold">${currencySymbol}${part.revenue.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    </tr>
                `).join('');
            }
            
            // Update low stock items table
            const lowStockTableBody = document.getElementById('lowStockTableBody');
            document.getElementById('lowStockCount').textContent = data.low_stock_items.length;
            
            if (data.low_stock_items.length === 0) {
                lowStockTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-8 text-green-600">
                            <i class="fas fa-check-circle mr-2"></i>All items are well stocked
                        </td>
                    </tr>
                `;
            } else {
                lowStockTableBody.innerHTML = data.low_stock_items.map(item => {
                    const urgencyColor = item.stock_quantity === 0 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-2 font-medium">${item.name}</td>
                            <td class="py-3 px-2 text-center">
                                <span class="px-2 py-1 text-xs rounded-full ${urgencyColor}">
                                    ${item.stock_quantity}
                                </span>
                            </td>
                            <td class="py-3 px-2 text-right">${currencySymbol}${item.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Process sales by day data for chart
            const salesLabels = data.sales_by_day.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            });
            const salesValues = data.sales_by_day.map(item => item.total);
            
            const salesData = {
                labels: salesLabels,
                datasets: [{
                    label: 'Sales',
                    data: salesValues,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }]
            };
            
            // Initialize sales chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: salesData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return currencySymbol + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Update revenue by category chart
            const categoryLabels = data.revenue_by_category.map(item => item.category);
            const categoryValues = data.revenue_by_category.map(item => item.revenue);
            
            const categoryData = {
                labels: categoryLabels,
                datasets: [{
                    data: categoryValues,
                    backgroundColor: [
                        '#3B82F6',
                        '#10B981',
                        '#F59E0B',
                        '#EF4444',
                        '#8B5CF6'
                    ]
                }]
            };
            
            // Initialize category chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: categoryData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading sales data:', error);
            // Show error messages in all tables
            document.getElementById('topProductsTableBody').innerHTML = `
                <tr>
                    <td colspan="3" class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error loading products data
                    </td>
                </tr>
            `;
            document.getElementById('lowStockTableBody').innerHTML = `
                <tr>
                    <td colspan="3" class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error loading low stock data
                    </td>
                </tr>
            `;
        });

    // Load today's sales data
    function loadTodaysSales() {
        fetch('/api/todays-sales')
            .then(response => response.json())
            .then(data => {
                const currencySymbol = '{{ currency_symbol }}';
                
                // Update today's sales card with null checks
                const totalRevenue = (data?.total_revenue || 0);
                const totalSales = (data?.total_sales || 0);
                
                document.getElementById('todaysRevenue').textContent = currencySymbol + totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('todaysSalesCount').textContent = totalSales.toLocaleString();
                
                // Set today's date
                const today = new Date();
                document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Update today's sales table
                const todaysSalesTableBody = document.getElementById('todaysSalesTableBody');
                const sales = (data?.sales || []);
                
                if (sales.length === 0) {
                    todaysSalesTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">
                                <i class="fas fa-info-circle mr-2"></i>No sales recorded today
                            </td>
                        </tr>
                    `;
                } else {
                    todaysSalesTableBody.innerHTML = sales.map(sale => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-2">${sale.sale_date ? new Date(sale.sale_date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</td>
                            <td class="py-3 px-2">${sale.customer_name || 'Walk-in Customer'}</td>
                            <td class="py-3 px-2 text-right font-semibold">${currencySymbol}${(sale.total_amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                            <td class="py-3 px-2">${getPaymentBadge(sale.payment_method || 'cash')}</td>
                            <td class="py-3 px-2">${sale.staff_name || 'Unknown'}</td>
                        </tr>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('Error loading today\'s sales:', error);
                document.getElementById('todaysSalesTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Error loading today's sales data
                        </td>
                    </tr>
                `;
            });
    }

    // Export reports function
    function exportReports() {
        const dateRange = document.getElementById('dateRange').value;
        
        // Create export data
        const exportData = {
            dateRange: dateRange,
            timestamp: new Date().toISOString()
        };
        
        // In a real app, this would generate and download a CSV/PDF report
        // For now, we'll show an alert
        alert(`Exporting reports for the last ${dateRange} days...\n\nThis is a demo - actual export would generate a downloadable file.`);
        
        // Simulate export (in real app, this would make an API call)
        console.log('Exporting reports:', exportData);
    }
</script>
{% endblock %}
